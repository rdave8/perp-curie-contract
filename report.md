# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
  - [H-1: Arbitrary `from` Passed to `transferFrom`](#h-1-arbitrary-from-passed-to-transferfrom)
  - [H-2: Storage Array Edited with Memory](#h-2-storage-array-edited-with-memory)
  - [H-3: Contract Name Reused in Different Files](#h-3-contract-name-reused-in-different-files)
  - [H-4: ETH transferred without address checks](#h-4-eth-transferred-without-address-checks)
  - [H-5: Reentrancy: State change after external call](#h-5-reentrancy-state-change-after-external-call)
- [Low Issues](#low-issues)
  - [L-1: Centralization Risk](#l-1-centralization-risk)
  - [L-2: Unsafe ERC20 Operation](#l-2-unsafe-erc20-operation)
  - [L-3: Address State Variable Set Without Checks](#l-3-address-state-variable-set-without-checks)
  - [L-4: Public Function Not Used Internally](#l-4-public-function-not-used-internally)
  - [L-5: Literal Instead of Constant](#l-5-literal-instead-of-constant)
  - [L-6: Empty `require()` / `revert()` Statement](#l-6-empty-require--revert-statement)
  - [L-7: `nonReentrant` is Not the First Modifier](#l-7-nonreentrant-is-not-the-first-modifier)
  - [L-8: Modifier Invoked Only Once](#l-8-modifier-invoked-only-once)
  - [L-9: Internal Function Used Only Once](#l-9-internal-function-used-only-once)
  - [L-10: Loop Contains `require`/`revert`](#l-10-loop-contains-requirerevert)
  - [L-11: Unused State Variable](#l-11-unused-state-variable)
  - [L-12: Dead Code](#l-12-dead-code)
  - [L-13: Costly operations inside loop](#l-13-costly-operations-inside-loop)
  - [L-14: Missing Inheritance](#l-14-missing-inheritance)
  - [L-15: Unused Import](#l-15-unused-import)
  - [L-16: State Variable Could Be Constant](#l-16-state-variable-could-be-constant)
  - [L-17: State Change Without Event](#l-17-state-change-without-event)
  - [L-18: State Variable Could Be Immutable](#l-18-state-variable-could-be-immutable)
  - [L-19: Unchecked Return](#l-19-unchecked-return)


# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 73 |
| Total nSLOC | 6019 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| contracts/AccountBalance.sol | 389 |
| contracts/BaseToken.sol | 90 |
| contracts/ClearingHouse.sol | 826 |
| contracts/ClearingHouseConfig.sol | 83 |
| contracts/CollateralManager.sol | 195 |
| contracts/DelegateApproval.sol | 70 |
| contracts/Exchange.sol | 471 |
| contracts/InsuranceFund.sol | 106 |
| contracts/MarketRegistry.sol | 166 |
| contracts/OrderBook.sol | 578 |
| contracts/QuoteToken.sol | 7 |
| contracts/Vault.sol | 678 |
| contracts/VirtualToken.sol | 39 |
| contracts/base/BlockContext.sol | 9 |
| contracts/base/ClearingHouseCallee.sol | 21 |
| contracts/base/OwnerPausable.sol | 22 |
| contracts/base/SafeOwnable.sol | 42 |
| contracts/base/UniswapV3CallbackBridge.sol | 22 |
| contracts/gsn/BaseRelayRecipient.sol | 36 |
| contracts/gsn/IRelayRecipient.sol | 7 |
| contracts/interface/IAccountBalance.sol | 79 |
| contracts/interface/IBaseToken.sol | 15 |
| contracts/interface/IClearingHouse.sol | 137 |
| contracts/interface/IClearingHouseConfig.sol | 22 |
| contracts/interface/ICollateralManager.sol | 42 |
| contracts/interface/IDelegateApproval.sol | 20 |
| contracts/interface/IERC20Metadata.sol | 7 |
| contracts/interface/IExchange.sol | 63 |
| contracts/interface/IIndexPrice.sol | 4 |
| contracts/interface/IInsuranceFund.sol | 22 |
| contracts/interface/IMarketRegistry.sol | 27 |
| contracts/interface/IMarketRegistryFeeManager.sol | 7 |
| contracts/interface/IOrderBook.sol | 107 |
| contracts/interface/IVault.sol | 78 |
| contracts/interface/IVirtualToken.sol | 4 |
| contracts/interface/external/IWETH9.sol | 6 |
| contracts/lib/AccountMarket.sol | 8 |
| contracts/lib/Collateral.sol | 9 |
| contracts/lib/Funding.sol | 64 |
| contracts/lib/OpenOrder.sol | 22 |
| contracts/lib/PerpFixedPoint96.sol | 4 |
| contracts/lib/PerpMath.sol | 83 |
| contracts/lib/PerpSafeCast.sol | 53 |
| contracts/lib/SettlementTokenMath.sol | 111 |
| contracts/lib/SwapMath.sol | 61 |
| contracts/lib/Tick.sol | 96 |
| contracts/lib/UniswapV3Broker.sol | 221 |
| contracts/storage/AccountBalanceStorage.sol | 10 |
| contracts/storage/BaseTokenStorage.sol | 12 |
| contracts/storage/ClearingHouseConfigStorage.sol | 18 |
| contracts/storage/ClearingHouseStorage.sol | 15 |
| contracts/storage/CollateralManagerStorage.sol | 18 |
| contracts/storage/DelegateApprovalStorage.sol | 4 |
| contracts/storage/ExchangeStorage.sol | 16 |
| contracts/storage/InsuranceFundStorage.sol | 9 |
| contracts/storage/MarketRegistryStorage.sol | 19 |
| contracts/storage/OrderBookStorage.sol | 11 |
| contracts/storage/VaultStorage.sol | 17 |
| contracts/test/TestAccountBalance.sol | 47 |
| contracts/test/TestAggregatorV3.sol | 42 |
| contracts/test/TestChainlinkPriceFeed.sol | 20 |
| contracts/test/TestClearingHouse.sol | 91 |
| contracts/test/TestERC20.sol | 36 |
| contracts/test/TestExchange.sol | 19 |
| contracts/test/TestLimitOrderBook.sol | 24 |
| contracts/test/TestMetaTxRecipient.sol | 15 |
| contracts/test/TestPerpMath.sol | 37 |
| contracts/test/TestPerpSafeCast.sol | 49 |
| contracts/test/TestSettlementTokenMath.sol | 88 |
| contracts/test/TestUniswapV3Broker.sol | 70 |
| contracts/test/TestVault.sol | 8 |
| contracts/test/TestWETH9.sol | 51 |
| contracts/test/TestWhitelistERC20.sol | 44 |
| **Total** | **6019** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 5 |
| Low | 19 |


# High Issues

## H-1: Arbitrary `from` Passed to `transferFrom`

Passing an arbitrary `from` address to `transferFrom` (or `safeTransferFrom`) can lead to loss of funds, because anyone can transfer tokens from the `from` address if an approval is made.

<details><summary>1 Found Instances</summary>


- Found in contracts/test/TestERC20.sol [Line: 42](contracts/test/TestERC20.sol#L42)

	```solidity
	        return super.transferFrom(sender, recipient, amount);
	```

</details>



## H-2: Storage Array Edited with Memory

Storage reference is passed to a function with a memory parameter. This will not update the storage variable as expected. Consider using storage parameters instead.

<details><summary>1 Found Instances</summary>


- Found in contracts/OrderBook.sol [Line: 487](contracts/OrderBook.sol#L487)

	```solidity
	            _getPendingFeeAndFeeGrowthInsideX128ByOrder(
	```

</details>



## H-3: Contract Name Reused in Different Files

When compiling contracts with certain development frameworks (for example: Truffle), having contracts with the same name across different files can lead to one being overwritten.

<details><summary>1 Found Instances</summary>


- Found in contracts/lib/SwapMath.sol [Line: 9](contracts/lib/SwapMath.sol#L9)

	```solidity
	library SwapMath {
	```

</details>



## H-4: ETH transferred without address checks

Consider introducing checks for `msg.sender` to ensure the recipient of the money is as intended.

<details><summary>1 Found Instances</summary>


- Found in contracts/test/TestWETH9.sol [Line: 26](contracts/test/TestWETH9.sol#L26)

	```solidity
	    function withdraw(uint256 wad) public {
	```

</details>



## H-5: Reentrancy: State change after external call

Changing state after an external call can lead to re-entrancy attacks.Use the checks-effects-interactions pattern to avoid this issue.

<details><summary>24 Found Instances</summary>


- Found in contracts/BaseToken.sol [Line: 35](contracts/BaseToken.sol#L35)

	State is changed at: `_priceFeed = priceFeedArg`, `_priceFeedDecimals = priceFeedDecimals`
	```solidity
	        uint8 priceFeedDecimals = IPriceFeedDispatcher(priceFeedArg).decimals();
	```

- Found in contracts/BaseToken.sol [Line: 70](contracts/BaseToken.sol#L70)

	State is changed at: `_priceFeed = priceFeedArg`, `_priceFeedDecimals = priceFeedDecimals`
	```solidity
	        uint8 priceFeedDecimals = IPriceFeedDispatcher(priceFeedArg).decimals();
	```

- Found in contracts/ClearingHouse.sol [Line: 110](contracts/ClearingHouse.sol#L110)

	State is changed at: `_clearingHouseConfig = clearingHouseConfigArg`, `_vault = vaultArg`, `_quoteToken = quoteTokenArg`, `_uniswapV3Factory = uniV3FactoryArg`, `_exchange = exchangeArg`, `_orderBook = orderBookArg`, `_accountBalance = accountBalanceArg`, `_insuranceFund = insuranceFundArg`, `_settlementTokenDecimals = IVault(_vault).decimals()`
	```solidity
	        require(IERC20Metadata(quoteTokenArg).decimals() == 18, "CH_QDN18");
	```

- Found in contracts/ClearingHouse.sol [Line: 122](contracts/ClearingHouse.sol#L122)

	State is changed at: `_clearingHouseConfig = clearingHouseConfigArg`, `_vault = vaultArg`, `_quoteToken = quoteTokenArg`, `_uniswapV3Factory = uniV3FactoryArg`, `_exchange = exchangeArg`, `_orderBook = orderBookArg`, `_accountBalance = accountBalanceArg`, `_insuranceFund = insuranceFundArg`, `_settlementTokenDecimals = IVault(_vault).decimals()`
	```solidity
	        address orderBookArg = IExchange(exchangeArg).getOrderBook();
	```

- Found in contracts/CollateralManager.sol [Line: 96](contracts/CollateralManager.sol#L96)

	State is changed at: `_collateralConfigMap[token] = config`
	```solidity
	        require(IVault(_vault).getSettlementToken() != token, "CM_CIS");
	```

- Found in contracts/Exchange.sol [Line: 119](contracts/Exchange.sol#L119)

	State is changed at: `_maxTickCrossedWithinBlockMap[baseToken] = maxTickCrossedWithinBlock`
	```solidity
	        require(IMarketRegistry(_marketRegistry).hasPool(baseToken), "EX_BTNE");
	```

- Found in contracts/Exchange.sol [Line: 219](contracts/Exchange.sol#L219)

	State is changed at: `(
                _lastSettledTimestampMap[baseToken],
                lastFundingGrowthGlobal.twPremiumX96,
                lastFundingGrowthGlobal.twPremiumDivBySqrtPriceX96
            ) = (timestamp, fundingGrowthGlobal.twPremiumX96, fundingGrowthGlobal.twPremiumDivBySqrtPriceX96)`, `_lastTickUpdatedTimestampMap[baseToken] = timestamp`, `_lastUpdatedTickMap[baseToken] = _getTick(baseToken)`
	```solidity
	        require(IMarketRegistry(_marketRegistry).hasPool(baseToken), "EX_BTNE");
	```

- Found in contracts/Exchange.sol [Line: 225](contracts/Exchange.sol#L225)

	State is changed at: `(
                _lastSettledTimestampMap[baseToken],
                lastFundingGrowthGlobal.twPremiumX96,
                lastFundingGrowthGlobal.twPremiumDivBySqrtPriceX96
            ) = (timestamp, fundingGrowthGlobal.twPremiumX96, fundingGrowthGlobal.twPremiumDivBySqrtPriceX96)`, `_lastTickUpdatedTimestampMap[baseToken] = timestamp`, `_lastUpdatedTickMap[baseToken] = _getTick(baseToken)`
	```solidity
	        (, uint32 premiumInterval) = IClearingHouseConfig(_clearingHouseConfig).getMarkPriceConfig();
	```

- Found in contracts/Exchange.sol [Line: 226](contracts/Exchange.sol#L226)

	State is changed at: `(
                _lastSettledTimestampMap[baseToken],
                lastFundingGrowthGlobal.twPremiumX96,
                lastFundingGrowthGlobal.twPremiumDivBySqrtPriceX96
            ) = (timestamp, fundingGrowthGlobal.twPremiumX96, fundingGrowthGlobal.twPremiumDivBySqrtPriceX96)`, `_lastTickUpdatedTimestampMap[baseToken] = timestamp`, `_lastUpdatedTickMap[baseToken] = _getTick(baseToken)`
	```solidity
	        try IBaseToken(baseToken).cacheTwap(premiumInterval) {} catch {}
	```

- Found in contracts/Exchange.sol [Line: 232](contracts/Exchange.sol#L232)

	State is changed at: `(
                _lastSettledTimestampMap[baseToken],
                lastFundingGrowthGlobal.twPremiumX96,
                lastFundingGrowthGlobal.twPremiumDivBySqrtPriceX96
            ) = (timestamp, fundingGrowthGlobal.twPremiumX96, fundingGrowthGlobal.twPremiumDivBySqrtPriceX96)`, `_lastTickUpdatedTimestampMap[baseToken] = timestamp`, `_lastUpdatedTickMap[baseToken] = _getTick(baseToken)`
	```solidity
	        fundingPayment = _updateFundingGrowth(
	```

- Found in contracts/Exchange.sol [Line: 241](contracts/Exchange.sol#L241)

	State is changed at: `(
                _lastSettledTimestampMap[baseToken],
                lastFundingGrowthGlobal.twPremiumX96,
                lastFundingGrowthGlobal.twPremiumDivBySqrtPriceX96
            ) = (timestamp, fundingGrowthGlobal.twPremiumX96, fundingGrowthGlobal.twPremiumDivBySqrtPriceX96)`, `_lastTickUpdatedTimestampMap[baseToken] = timestamp`, `_lastUpdatedTickMap[baseToken] = _getTick(baseToken)`
	```solidity
	        uint256 timestamp =
	```

- Found in contracts/InsuranceFund.sol [Line: 62](contracts/InsuranceFund.sol#L62)

	State is changed at: `_surplusBeneficiary = surplusBeneficiary`
	```solidity
	        require(ISurplusBeneficiary(surplusBeneficiary).getToken() == _token, "IF_TNM");
	```

- Found in contracts/MarketRegistry.sol [Line: 73](contracts/MarketRegistry.sol#L73)

	State is changed at: `_poolMap[baseToken] = pool`, `_uniswapFeeRatioMap[baseToken] = feeRatio`, `_exchangeFeeRatioMap[baseToken] = feeRatio`
	```solidity
	        require(IERC20Metadata(baseToken).decimals() == 18, "MR_BDN18");
	```

- Found in contracts/MarketRegistry.sol [Line: 75](contracts/MarketRegistry.sol#L75)

	State is changed at: `_poolMap[baseToken] = pool`, `_uniswapFeeRatioMap[baseToken] = feeRatio`, `_exchangeFeeRatioMap[baseToken] = feeRatio`
	```solidity
	        require(IERC20Metadata(baseToken).balanceOf(_clearingHouse) == type(uint256).max, "MR_CHBNE");
	```

- Found in contracts/MarketRegistry.sol [Line: 78](contracts/MarketRegistry.sol#L78)

	State is changed at: `_poolMap[baseToken] = pool`, `_uniswapFeeRatioMap[baseToken] = feeRatio`, `_exchangeFeeRatioMap[baseToken] = feeRatio`
	```solidity
	        require(IERC20Metadata(_quoteToken).totalSupply() == type(uint256).max, "MR_QTSNE");
	```

- Found in contracts/MarketRegistry.sol [Line: 93](contracts/MarketRegistry.sol#L93)

	State is changed at: `_poolMap[baseToken] = pool`, `_uniswapFeeRatioMap[baseToken] = feeRatio`, `_exchangeFeeRatioMap[baseToken] = feeRatio`
	```solidity
	        require(IVirtualToken(baseToken).isInWhitelist(_clearingHouse), "MR_CNBWL");
	```

- Found in contracts/MarketRegistry.sol [Line: 95](contracts/MarketRegistry.sol#L95)

	State is changed at: `_poolMap[baseToken] = pool`, `_uniswapFeeRatioMap[baseToken] = feeRatio`, `_exchangeFeeRatioMap[baseToken] = feeRatio`
	```solidity
	        require(IVirtualToken(baseToken).isInWhitelist(pool), "MR_PNBWL");
	```

- Found in contracts/MarketRegistry.sol [Line: 98](contracts/MarketRegistry.sol#L98)

	State is changed at: `_poolMap[baseToken] = pool`, `_uniswapFeeRatioMap[baseToken] = feeRatio`, `_exchangeFeeRatioMap[baseToken] = feeRatio`
	```solidity
	        require(IVirtualToken(_quoteToken).isInWhitelist(_clearingHouse), "MR_CHNQWL");
	```

- Found in contracts/MarketRegistry.sol [Line: 100](contracts/MarketRegistry.sol#L100)

	State is changed at: `_poolMap[baseToken] = pool`, `_uniswapFeeRatioMap[baseToken] = feeRatio`, `_exchangeFeeRatioMap[baseToken] = feeRatio`
	```solidity
	        require(IVirtualToken(_quoteToken).isInWhitelist(pool), "MR_PNQWL");
	```

- Found in contracts/OrderBook.sol [Line: 207](contracts/OrderBook.sol#L207)

	State is changed at: `order.lastTwPremiumGrowthInsideX96 = fundingGrowthRangeInfo.twPremiumGrowthInsideX96`, `order.lastTwPremiumGrowthBelowX96 = fundingGrowthRangeInfo.twPremiumGrowthBelowX96`, `order.lastTwPremiumDivBySqrtPriceGrowthInsideX96 = fundingGrowthRangeInfo
                .twPremiumDivBySqrtPriceGrowthInsideX96`
	```solidity
	        address pool = IMarketRegistry(_marketRegistry).getPool(baseToken);
	```

- Found in contracts/Vault.sol [Line: 76](contracts/Vault.sol#L76)

	State is changed at: `_decimals = decimalsArg`, `_settlementToken = settlementTokenArg`, `_insuranceFund = insuranceFundArg`, `_clearingHouseConfig = clearingHouseConfigArg`, `_accountBalance = accountBalanceArg`, `_exchange = exchangeArg`
	```solidity
	        address settlementTokenArg = IInsuranceFund(insuranceFundArg).getToken();
	```

- Found in contracts/Vault.sol [Line: 77](contracts/Vault.sol#L77)

	State is changed at: `_decimals = decimalsArg`, `_settlementToken = settlementTokenArg`, `_insuranceFund = insuranceFundArg`, `_clearingHouseConfig = clearingHouseConfigArg`, `_accountBalance = accountBalanceArg`, `_exchange = exchangeArg`
	```solidity
	        uint8 decimalsArg = IERC20Metadata(settlementTokenArg).decimals();
	```

- Found in contracts/test/TestClearingHouse.sol [Line: 39](contracts/test/TestClearingHouse.sol#L39)

	State is changed at: `_testBlockTimestamp = blockTimestamp`
	```solidity
	        TestAccountBalance(_accountBalance).setBlockTimestamp(blockTimestamp);
	```

- Found in contracts/test/TestClearingHouse.sol [Line: 40](contracts/test/TestClearingHouse.sol#L40)

	State is changed at: `_testBlockTimestamp = blockTimestamp`
	```solidity
	        TestExchange(_exchange).setBlockTimestamp(blockTimestamp);
	```

</details>



# Low Issues

## L-1: Centralization Risk

Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details><summary>52 Found Instances</summary>


- Found in contracts/AccountBalance.sol [Line: 57](contracts/AccountBalance.sol#L57)

	```solidity
	    function setVault(address vaultArg) external onlyOwner {
	```

- Found in contracts/BaseToken.sol [Line: 44](contracts/BaseToken.sol#L44)

	```solidity
	    function pause() external onlyOwner {
	```

- Found in contracts/BaseToken.sol [Line: 53](contracts/BaseToken.sol#L53)

	```solidity
	    function close(uint256 closedPrice) external onlyOwner {
	```

- Found in contracts/BaseToken.sol [Line: 68](contracts/BaseToken.sol#L68)

	```solidity
	    function setPriceFeed(address priceFeedArg) external onlyOwner {
	```

- Found in contracts/ClearingHouse.sol [Line: 150](contracts/ClearingHouse.sol#L150)

	```solidity
	    function setDelegateApproval(address delegateApprovalArg) external onlyOwner {
	```

- Found in contracts/ClearingHouseConfig.sol [Line: 41](contracts/ClearingHouseConfig.sol#L41)

	```solidity
	        onlyOwner
	```

- Found in contracts/ClearingHouseConfig.sol [Line: 47](contracts/ClearingHouseConfig.sol#L47)

	```solidity
	    function setTwapInterval(uint32 twapIntervalArg) external onlyOwner {
	```

- Found in contracts/ClearingHouseConfig.sol [Line: 52](contracts/ClearingHouseConfig.sol#L52)

	```solidity
	    function setMaxMarketsPerAccount(uint8 maxMarketsPerAccountArg) external onlyOwner {
	```

- Found in contracts/ClearingHouseConfig.sol [Line: 57](contracts/ClearingHouseConfig.sol#L57)

	```solidity
	    function setSettlementTokenBalanceCap(uint256 cap) external onlyOwner {
	```

- Found in contracts/ClearingHouseConfig.sol [Line: 62](contracts/ClearingHouseConfig.sol#L62)

	```solidity
	    function setMaxFundingRate(uint24 rate) external onlyOwner {
	```

- Found in contracts/ClearingHouseConfig.sol [Line: 67](contracts/ClearingHouseConfig.sol#L67)

	```solidity
	    function setMarkPriceMarketTwapInterval(uint32 twapIntervalArg) external onlyOwner {
	```

- Found in contracts/ClearingHouseConfig.sol [Line: 75](contracts/ClearingHouseConfig.sol#L75)

	```solidity
	    function setMarkPricePremiumInterval(uint32 premiumIntervalArg) external onlyOwner {
	```

- Found in contracts/CollateralManager.sol [Line: 87](contracts/CollateralManager.sol#L87)

	```solidity
	        onlyOwner
	```

- Found in contracts/CollateralManager.sol [Line: 102](contracts/CollateralManager.sol#L102)

	```solidity
	    function setPriceFeed(address token, address priceFeed) external onlyOwner {
	```

- Found in contracts/CollateralManager.sol [Line: 111](contracts/CollateralManager.sol#L111)

	```solidity
	    function setCollateralRatio(address token, uint24 collateralRatio) external checkRatio(collateralRatio) onlyOwner {
	```

- Found in contracts/CollateralManager.sol [Line: 118](contracts/CollateralManager.sol#L118)

	```solidity
	    function setDiscountRatio(address token, uint24 discountRatio) external checkRatio(discountRatio) onlyOwner {
	```

- Found in contracts/CollateralManager.sol [Line: 125](contracts/CollateralManager.sol#L125)

	```solidity
	    function setDepositCap(address token, uint256 depositCap) external onlyOwner {
	```

- Found in contracts/CollateralManager.sol [Line: 131](contracts/CollateralManager.sol#L131)

	```solidity
	    function setMaxCollateralTokensPerAccount(uint8 maxCollateralTokensPerAccount) external onlyOwner {
	```

- Found in contracts/CollateralManager.sol [Line: 136](contracts/CollateralManager.sol#L136)

	```solidity
	    function setMmRatioBuffer(uint24 mmRatioBuffer) external onlyOwner {
	```

- Found in contracts/CollateralManager.sol [Line: 146](contracts/CollateralManager.sol#L146)

	```solidity
	        onlyOwner
	```

- Found in contracts/CollateralManager.sol [Line: 152](contracts/CollateralManager.sol#L152)

	```solidity
	    function setLiquidationRatio(uint24 liquidationRatio) external checkRatio(liquidationRatio) onlyOwner {
	```

- Found in contracts/CollateralManager.sol [Line: 160](contracts/CollateralManager.sol#L160)

	```solidity
	        onlyOwner
	```

- Found in contracts/CollateralManager.sol [Line: 166](contracts/CollateralManager.sol#L166)

	```solidity
	    function setDebtThreshold(uint256 debtThreshold) external onlyOwner {
	```

- Found in contracts/CollateralManager.sol [Line: 174](contracts/CollateralManager.sol#L174)

	```solidity
	    function setWhitelistedDebtThreshold(address trader, uint256 whitelistedDebtThreshold) external onlyOwner {
	```

- Found in contracts/CollateralManager.sol [Line: 185](contracts/CollateralManager.sol#L185)

	```solidity
	    function setCollateralValueDust(uint256 collateralValueDust) external onlyOwner {
	```

- Found in contracts/Exchange.sol [Line: 103](contracts/Exchange.sol#L103)

	```solidity
	    function setAccountBalance(address accountBalanceArg) external onlyOwner {
	```

- Found in contracts/Exchange.sol [Line: 115](contracts/Exchange.sol#L115)

	```solidity
	    function setMaxTickCrossedWithinBlock(address baseToken, uint24 maxTickCrossedWithinBlock) external onlyOwner {
	```

- Found in contracts/InsuranceFund.sol [Line: 45](contracts/InsuranceFund.sol#L45)

	```solidity
	    function setVault(address vaultArg) external onlyOwner {
	```

- Found in contracts/InsuranceFund.sol [Line: 52](contracts/InsuranceFund.sol#L52)

	```solidity
	    function setDistributionThreshold(uint256 distributionThreshold) external onlyOwner {
	```

- Found in contracts/InsuranceFund.sol [Line: 57](contracts/InsuranceFund.sol#L57)

	```solidity
	    function setSurplusBeneficiary(address surplusBeneficiary) external onlyOwner {
	```

- Found in contracts/MarketRegistry.sol [Line: 69](contracts/MarketRegistry.sol#L69)

	```solidity
	    function addPool(address baseToken, uint24 feeRatio) external onlyOwner returns (address) {
	```

- Found in contracts/MarketRegistry.sol [Line: 114](contracts/MarketRegistry.sol#L114)

	```solidity
	        onlyOwner
	```

- Found in contracts/MarketRegistry.sol [Line: 124](contracts/MarketRegistry.sol#L124)

	```solidity
	        onlyOwner
	```

- Found in contracts/MarketRegistry.sol [Line: 130](contracts/MarketRegistry.sol#L130)

	```solidity
	    function setMaxOrdersPerMarket(uint8 maxOrdersPerMarketArg) external onlyOwner {
	```

- Found in contracts/MarketRegistry.sol [Line: 135](contracts/MarketRegistry.sol#L135)

	```solidity
	    function setMarketMaxPriceSpreadRatio(address baseToken, uint24 ratio) external onlyOwner {
	```

- Found in contracts/MarketRegistry.sol [Line: 150](contracts/MarketRegistry.sol#L150)

	```solidity
	    function setFeeManager(address accountArg, bool isFeeManagerArg) external onlyOwner {
	```

- Found in contracts/OrderBook.sol [Line: 93](contracts/OrderBook.sol#L93)

	```solidity
	    function setExchange(address exchangeArg) external onlyOwner {
	```

- Found in contracts/Vault.sol [Line: 100](contracts/Vault.sol#L100)

	```solidity
	    function setTrustedForwarder(address trustedForwarderArg) external onlyOwner {
	```

- Found in contracts/Vault.sol [Line: 108](contracts/Vault.sol#L108)

	```solidity
	    function setClearingHouse(address clearingHouseArg) external onlyOwner {
	```

- Found in contracts/Vault.sol [Line: 116](contracts/Vault.sol#L116)

	```solidity
	    function setCollateralManager(address collateralManagerArg) external onlyOwner {
	```

- Found in contracts/Vault.sol [Line: 124](contracts/Vault.sol#L124)

	```solidity
	    function setWETH9(address WETH9Arg) external onlyOwner {
	```

- Found in contracts/VirtualToken.sol [Line: 22](contracts/VirtualToken.sol#L22)

	```solidity
	    function mintMaximumTo(address recipient) external onlyOwner {
	```

- Found in contracts/VirtualToken.sol [Line: 26](contracts/VirtualToken.sol#L26)

	```solidity
	    function addWhitelist(address account) external onlyOwner {
	```

- Found in contracts/VirtualToken.sol [Line: 31](contracts/VirtualToken.sol#L31)

	```solidity
	    function removeWhitelist(address account) external onlyOwner {
	```

- Found in contracts/base/ClearingHouseCallee.sol [Line: 30](contracts/base/ClearingHouseCallee.sol#L30)

	```solidity
	    function setClearingHouse(address clearingHouseArg) external onlyOwner {
	```

- Found in contracts/base/OwnerPausable.sol [Line: 17](contracts/base/OwnerPausable.sol#L17)

	```solidity
	    function pause() external onlyOwner {
	```

- Found in contracts/base/OwnerPausable.sol [Line: 21](contracts/base/OwnerPausable.sol#L21)

	```solidity
	    function unpause() external onlyOwner {
	```

- Found in contracts/base/SafeOwnable.sol [Line: 42](contracts/base/SafeOwnable.sol#L42)

	```solidity
	    function renounceOwnership() external virtual onlyOwner {
	```

- Found in contracts/base/SafeOwnable.sol [Line: 53](contracts/base/SafeOwnable.sol#L53)

	```solidity
	    function setOwner(address newOwner) external onlyOwner {
	```

- Found in contracts/test/TestClearingHouse.sol [Line: 52](contracts/test/TestClearingHouse.sol#L52)

	```solidity
	    function setDelegateApprovalUnsafe(address delegateApprovalArg) external onlyOwner {
	```

- Found in contracts/test/TestWhitelistERC20.sol [Line: 26](contracts/test/TestWhitelistERC20.sol#L26)

	```solidity
	    function addWhitelist(address addr) external onlyOwner {
	```

- Found in contracts/test/TestWhitelistERC20.sol [Line: 30](contracts/test/TestWhitelistERC20.sol#L30)

	```solidity
	    function removeWhitelist(address addr) external onlyOwner {
	```

</details>



## L-2: Unsafe ERC20 Operation

ERC20 functions may not behave as expected. For example: return values are not always meaningful. It is recommended to use OpenZeppelin's SafeERC20 library.

<details><summary>9 Found Instances</summary>


- Found in contracts/ClearingHouse.sol [Line: 597](contracts/ClearingHouse.sol#L597)

	```solidity
	        require(IERC20Metadata(token).transfer(to, amount), "CH_TF");
	```

- Found in contracts/InsuranceFund.sol [Line: 83](contracts/InsuranceFund.sol#L83)

	```solidity
	        IERC20Upgradeable(token).approve(vault, repaidAmount);
	```

- Found in contracts/test/TestERC20.sol [Line: 42](contracts/test/TestERC20.sol#L42)

	```solidity
	        return super.transferFrom(sender, recipient, amount);
	```

- Found in contracts/test/TestUniswapV3Broker.sol [Line: 39](contracts/test/TestUniswapV3Broker.sol#L39)

	```solidity
	            IERC20Metadata(IUniswapV3Pool(pool).token0()).transfer(msg.sender, amount0Owed);
	```

- Found in contracts/test/TestUniswapV3Broker.sol [Line: 42](contracts/test/TestUniswapV3Broker.sol#L42)

	```solidity
	            IERC20Metadata(IUniswapV3Pool(pool).token1()).transfer(msg.sender, amount1Owed);
	```

- Found in contracts/test/TestUniswapV3Broker.sol [Line: 70](contracts/test/TestUniswapV3Broker.sol#L70)

	```solidity
	        IERC20Metadata(token).transfer(msg.sender, amountToPay);
	```

- Found in contracts/test/TestWETH9.sol [Line: 29](contracts/test/TestWETH9.sol#L29)

	```solidity
	        msg.sender.transfer(wad);
	```

- Found in contracts/test/TestWhitelistERC20.sol [Line: 44](contracts/test/TestWhitelistERC20.sol#L44)

	```solidity
	        return super.transfer(recipient, amount);
	```

- Found in contracts/test/TestWhitelistERC20.sol [Line: 52](contracts/test/TestWhitelistERC20.sol#L52)

	```solidity
	        return super.transferFrom(sender, recipient, amount);
	```

</details>



## L-3: Address State Variable Set Without Checks

Check for `address(0)` when assigning values to address state variables.

<details><summary>36 Found Instances</summary>


- Found in contracts/AccountBalance.sol [Line: 53](contracts/AccountBalance.sol#L53)

	```solidity
	        _clearingHouseConfig = clearingHouseConfigArg;
	```

- Found in contracts/AccountBalance.sol [Line: 54](contracts/AccountBalance.sol#L54)

	```solidity
	        _orderBook = orderBookArg;
	```

- Found in contracts/AccountBalance.sol [Line: 60](contracts/AccountBalance.sol#L60)

	```solidity
	        _vault = vaultArg;
	```

- Found in contracts/BaseToken.sol [Line: 40](contracts/BaseToken.sol#L40)

	```solidity
	        _priceFeed = priceFeedArg;
	```

- Found in contracts/BaseToken.sol [Line: 74](contracts/BaseToken.sol#L74)

	```solidity
	        _priceFeed = priceFeedArg;
	```

- Found in contracts/ClearingHouse.sol [Line: 129](contracts/ClearingHouse.sol#L129)

	```solidity
	        _clearingHouseConfig = clearingHouseConfigArg;
	```

- Found in contracts/ClearingHouse.sol [Line: 130](contracts/ClearingHouse.sol#L130)

	```solidity
	        _vault = vaultArg;
	```

- Found in contracts/ClearingHouse.sol [Line: 132](contracts/ClearingHouse.sol#L132)

	```solidity
	        _uniswapV3Factory = uniV3FactoryArg;
	```

- Found in contracts/ClearingHouse.sol [Line: 133](contracts/ClearingHouse.sol#L133)

	```solidity
	        _exchange = exchangeArg;
	```

- Found in contracts/ClearingHouse.sol [Line: 135](contracts/ClearingHouse.sol#L135)

	```solidity
	        _accountBalance = accountBalanceArg;
	```

- Found in contracts/ClearingHouse.sol [Line: 136](contracts/ClearingHouse.sol#L136)

	```solidity
	        _insuranceFund = insuranceFundArg;
	```

- Found in contracts/ClearingHouse.sol [Line: 153](contracts/ClearingHouse.sol#L153)

	```solidity
	        _delegateApproval = delegateApprovalArg;
	```

- Found in contracts/CollateralManager.sol [Line: 59](contracts/CollateralManager.sol#L59)

	```solidity
	        _clearingHouseConfig = clearingHouseConfigArg;
	```

- Found in contracts/CollateralManager.sol [Line: 60](contracts/CollateralManager.sol#L60)

	```solidity
	        _vault = vaultArg;
	```

- Found in contracts/Exchange.sol [Line: 98](contracts/Exchange.sol#L98)

	```solidity
	        _orderBook = orderBookArg;
	```

- Found in contracts/Exchange.sol [Line: 99](contracts/Exchange.sol#L99)

	```solidity
	        _clearingHouseConfig = clearingHouseConfigArg;
	```

- Found in contracts/InsuranceFund.sol [Line: 42](contracts/InsuranceFund.sol#L42)

	```solidity
	        _token = tokenArg;
	```

- Found in contracts/InsuranceFund.sol [Line: 48](contracts/InsuranceFund.sol#L48)

	```solidity
	        _vault = vaultArg;
	```

- Found in contracts/MarketRegistry.sol [Line: 64](contracts/MarketRegistry.sol#L64)

	```solidity
	        _uniswapV3Factory = uniswapV3FactoryArg;
	```

- Found in contracts/MarketRegistry.sol [Line: 65](contracts/MarketRegistry.sol#L65)

	```solidity
	        _quoteToken = quoteTokenArg;
	```

- Found in contracts/OrderBook.sol [Line: 94](contracts/OrderBook.sol#L94)

	```solidity
	        _exchange = exchangeArg;
	```

- Found in contracts/Vault.sol [Line: 94](contracts/Vault.sol#L94)

	```solidity
	        _insuranceFund = insuranceFundArg;
	```

- Found in contracts/Vault.sol [Line: 95](contracts/Vault.sol#L95)

	```solidity
	        _clearingHouseConfig = clearingHouseConfigArg;
	```

- Found in contracts/Vault.sol [Line: 96](contracts/Vault.sol#L96)

	```solidity
	        _accountBalance = accountBalanceArg;
	```

- Found in contracts/Vault.sol [Line: 97](contracts/Vault.sol#L97)

	```solidity
	        _exchange = exchangeArg;
	```

- Found in contracts/Vault.sol [Line: 112](contracts/Vault.sol#L112)

	```solidity
	        _clearingHouse = clearingHouseArg;
	```

- Found in contracts/Vault.sol [Line: 120](contracts/Vault.sol#L120)

	```solidity
	        _collateralManager = collateralManagerArg;
	```

- Found in contracts/Vault.sol [Line: 128](contracts/Vault.sol#L128)

	```solidity
	        _WETH9 = WETH9Arg;
	```

- Found in contracts/base/ClearingHouseCallee.sol [Line: 31](contracts/base/ClearingHouseCallee.sol#L31)

	```solidity
	        _clearingHouse = clearingHouseArg;
	```

- Found in contracts/base/UniswapV3CallbackBridge.sol [Line: 37](contracts/base/UniswapV3CallbackBridge.sol#L37)

	```solidity
	        _marketRegistry = marketRegistryArg;
	```

- Found in contracts/gsn/BaseRelayRecipient.sol [Line: 40](contracts/gsn/BaseRelayRecipient.sol#L40)

	```solidity
	        _trustedForwarder = trustedForwarderArg;
	```

- Found in contracts/test/TestAccountBalance.sol [Line: 24](contracts/test/TestAccountBalance.sol#L24)

	```solidity
	        _clearingHouseConfig = clearingHouseConfigArg;
	```

- Found in contracts/test/TestAccountBalance.sol [Line: 25](contracts/test/TestAccountBalance.sol#L25)

	```solidity
	        _orderBook = orderBookArg;
	```

- Found in contracts/test/TestClearingHouse.sol [Line: 53](contracts/test/TestClearingHouse.sol#L53)

	```solidity
	        _delegateApproval = delegateApprovalArg;
	```

- Found in contracts/test/TestLimitOrderBook.sol [Line: 11](contracts/test/TestLimitOrderBook.sol#L11)

	```solidity
	        _clearingHouse = clearingHouseArg;
	```

- Found in contracts/test/TestUniswapV3Broker.sol [Line: 22](contracts/test/TestUniswapV3Broker.sol#L22)

	```solidity
	        _factory = factory;
	```

</details>



## L-4: Public Function Not Used Internally

If a function is marked public but is not used internally, consider marking it as `external`.

<details><summary>6 Found Instances</summary>


- Found in contracts/ClearingHouse.sol [Line: 96](contracts/ClearingHouse.sol#L96)

	```solidity
	    function initialize(
	```

- Found in contracts/test/TestUniswapV3Broker.sol [Line: 87](contracts/test/TestUniswapV3Broker.sol#L87)

	```solidity
	    function swap(UniswapV3Broker.SwapParams calldata params)
	```

- Found in contracts/test/TestWETH9.sol [Line: 26](contracts/test/TestWETH9.sol#L26)

	```solidity
	    function withdraw(uint256 wad) public {
	```

- Found in contracts/test/TestWETH9.sol [Line: 33](contracts/test/TestWETH9.sol#L33)

	```solidity
	    function totalSupply() public view returns (uint256) {
	```

- Found in contracts/test/TestWETH9.sol [Line: 37](contracts/test/TestWETH9.sol#L37)

	```solidity
	    function approve(address guy, uint256 wad) public returns (bool) {
	```

- Found in contracts/test/TestWETH9.sol [Line: 43](contracts/test/TestWETH9.sol#L43)

	```solidity
	    function transfer(address dst, uint256 wad) public returns (bool) {
	```

</details>



## L-5: Literal Instead of Constant

Define and use `constant` variables instead of using literals. If the same constant literal value is used multiple times, create a constant state variable and reference it throughout the contract.

<details><summary>44 Found Instances</summary>


- Found in contracts/AccountBalance.sol [Line: 167](contracts/AccountBalance.sol#L167)

	```solidity
	        positionNotional = positionSize.mulDiv(closedPrice.toInt256(), 1e18);
	```

- Found in contracts/AccountBalance.sol [Line: 237](contracts/AccountBalance.sol#L237)

	```solidity
	                baseDebtValue = baseBalance.mulDiv(_getReferencePrice(baseToken).toInt256(), 1e18);
	```

- Found in contracts/AccountBalance.sol [Line: 321](contracts/AccountBalance.sol#L321)

	```solidity
	        uint24 maxLiquidateRatio = 1e6; // 100%
	```

- Found in contracts/AccountBalance.sol [Line: 325](contracts/AccountBalance.sol#L325)

	```solidity
	                .mulDiv(getTotalAbsPositionValue(trader), 1e6, positionValueAbs.mul(2))
	```

- Found in contracts/AccountBalance.sol [Line: 327](contracts/AccountBalance.sol#L327)

	```solidity
	            if (maxLiquidateRatio > 1e6) {
	```

- Found in contracts/AccountBalance.sol [Line: 328](contracts/AccountBalance.sol#L328)

	```solidity
	                maxLiquidateRatio = 1e6;
	```

- Found in contracts/AccountBalance.sol [Line: 486](contracts/AccountBalance.sol#L486)

	```solidity
	        return positionSize.mulDiv(price.toInt256(), 1e18);
	```

- Found in contracts/ClearingHouseConfig.sol [Line: 28](contracts/ClearingHouseConfig.sol#L28)

	```solidity
	        _imRatio = 0.1e6; // initial-margin ratio, 10% in decimal 6
	```

- Found in contracts/ClearingHouseConfig.sol [Line: 31](contracts/ClearingHouseConfig.sol#L31)

	```solidity
	        _maxFundingRate = 0.1e6; // max funding rate, 10% in decimal 6
	```

- Found in contracts/ClearingHouseConfig.sol [Line: 32](contracts/ClearingHouseConfig.sol#L32)

	```solidity
	        _twapInterval = 15 minutes;
	```

- Found in contracts/ClearingHouseConfig.sol [Line: 35](contracts/ClearingHouseConfig.sol#L35)

	```solidity
	        _markPricePremiumInterval = 15 minutes;
	```

- Found in contracts/Exchange.sol [Line: 207](contracts/Exchange.sol#L207)

	```solidity
	                closedRatio: params.isClose ? FullMath.mulDiv(baseAbs, 1e6, params.amount).toUint24() : 0
	```

- Found in contracts/Exchange.sol [Line: 663](contracts/Exchange.sol#L663)

	```solidity
	        return spread.mulDiv(1e6, indexPrice);
	```

- Found in contracts/OrderBook.sol [Line: 335](contracts/OrderBook.sol#L335)

	```solidity
	                    step.fee = FullMath.mulDivRoundingUp(step.amountOut, params.exchangeFeeRatio, 1e6);
	```

- Found in contracts/OrderBook.sol [Line: 339](contracts/OrderBook.sol#L339)

	```solidity
	                uint256 stepInsuranceFundFee = FullMath.mulDivRoundingUp(step.fee, params.insuranceFundFeeRatio, 1e6);
	```

- Found in contracts/Vault.sol [Line: 80](contracts/Vault.sol#L80)

	```solidity
	        require(decimalsArg <= 18, "V_ISTD");
	```

- Found in contracts/Vault.sol [Line: 929](contracts/Vault.sol#L929)

	```solidity
	            collateralTokenDecimals > 18
	```

- Found in contracts/Vault.sol [Line: 930](contracts/Vault.sol#L930)

	```solidity
	                ? collateral.mulDiv(price, 10**priceFeedDecimals).convertTokenDecimals(collateralTokenDecimals, 18)
	```

- Found in contracts/Vault.sol [Line: 931](contracts/Vault.sol#L931)

	```solidity
	                : collateral.convertTokenDecimals(collateralTokenDecimals, 18).mulDiv(price, 10**priceFeedDecimals);
	```

- Found in contracts/Vault.sol [Line: 945](contracts/Vault.sol#L945)

	```solidity
	            collateralTokenDecimals > 18
	```

- Found in contracts/Vault.sol [Line: 946](contracts/Vault.sol#L946)

	```solidity
	                ? settlementX10_18.convertTokenDecimals(18, collateralTokenDecimals).mulDivRoundingUp(
	```

- Found in contracts/Vault.sol [Line: 947](contracts/Vault.sol#L947)

	```solidity
	                    10**priceFeedDecimals,
	```

- Found in contracts/Vault.sol [Line: 950](contracts/Vault.sol#L950)

	```solidity
	                : settlementX10_18.mulDivRoundingUp(10**priceFeedDecimals, price).convertTokenDecimals(
	```

- Found in contracts/Vault.sol [Line: 951](contracts/Vault.sol#L951)

	```solidity
	                    18,
	```

- Found in contracts/gsn/BaseRelayRecipient.sol [Line: 52](contracts/gsn/BaseRelayRecipient.sol#L52)

	```solidity
	        if (msg.data.length >= 20 && isTrustedForwarder(msg.sender)) {
	```

- Found in contracts/gsn/BaseRelayRecipient.sol [Line: 73](contracts/gsn/BaseRelayRecipient.sol#L73)

	```solidity
	        if (msg.data.length >= 20 && isTrustedForwarder(msg.sender)) {
	```

- Found in contracts/gsn/BaseRelayRecipient.sol [Line: 74](contracts/gsn/BaseRelayRecipient.sol#L74)

	```solidity
	            return msg.data[0:msg.data.length - 20];
	```

- Found in contracts/lib/PerpMath.sol [Line: 75](contracts/lib/PerpMath.sol#L75)

	```solidity
	        return FullMath.mulDiv(value, ratio, 1e6);
	```

- Found in contracts/lib/PerpMath.sol [Line: 79](contracts/lib/PerpMath.sol#L79)

	```solidity
	        return mulDiv(value, int256(ratio), 1e6);
	```

- Found in contracts/lib/PerpMath.sol [Line: 83](contracts/lib/PerpMath.sol#L83)

	```solidity
	        return FullMath.mulDiv(value, 1e6, ratio);
	```

- Found in contracts/lib/SettlementTokenMath.sol [Line: 86](contracts/lib/SettlementTokenMath.sol#L86)

	```solidity
	        return amount.mul(10**(18 - decimals));
	```

- Found in contracts/lib/SettlementTokenMath.sol [Line: 91](contracts/lib/SettlementTokenMath.sol#L91)

	```solidity
	        return amount.mul(int256(10**(18 - decimals)));
	```

- Found in contracts/lib/SettlementTokenMath.sol [Line: 96](contracts/lib/SettlementTokenMath.sol#L96)

	```solidity
	        return amount.div(10**(18 - decimals));
	```

- Found in contracts/lib/SettlementTokenMath.sol [Line: 102](contracts/lib/SettlementTokenMath.sol#L102)

	```solidity
	        uint256 denominator = 10**(18 - decimals);
	```

- Found in contracts/lib/SettlementTokenMath.sol [Line: 121](contracts/lib/SettlementTokenMath.sol#L121)

	```solidity
	                ? amount.div(10**(fromDecimals - toDecimals))
	```

- Found in contracts/lib/SettlementTokenMath.sol [Line: 122](contracts/lib/SettlementTokenMath.sol#L122)

	```solidity
	                : amount.mul(10**(toDecimals - fromDecimals));
	```

- Found in contracts/lib/SettlementTokenMath.sol [Line: 136](contracts/lib/SettlementTokenMath.sol#L136)

	```solidity
	            return amount.mul(int256(10**(toDecimals - fromDecimals)));
	```

- Found in contracts/lib/SettlementTokenMath.sol [Line: 139](contracts/lib/SettlementTokenMath.sol#L139)

	```solidity
	        uint256 denominator = 10**(fromDecimals - toDecimals);
	```

</details>



## L-6: Empty `require()` / `revert()` Statement

Use descriptive reason strings or custom errors for revert paths.

<details><summary>8 Found Instances</summary>


- Found in contracts/test/TestAggregatorV3.sol [Line: 9](contracts/test/TestAggregatorV3.sol#L9)

	```solidity
	        revert();
	```

- Found in contracts/test/TestAggregatorV3.sol [Line: 13](contracts/test/TestAggregatorV3.sol#L13)

	```solidity
	        revert();
	```

- Found in contracts/test/TestAggregatorV3.sol [Line: 17](contracts/test/TestAggregatorV3.sol#L17)

	```solidity
	        revert();
	```

- Found in contracts/test/TestAggregatorV3.sol [Line: 32](contracts/test/TestAggregatorV3.sol#L32)

	```solidity
	        revert();
	```

- Found in contracts/test/TestAggregatorV3.sol [Line: 47](contracts/test/TestAggregatorV3.sol#L47)

	```solidity
	        revert();
	```

- Found in contracts/test/TestWETH9.sol [Line: 27](contracts/test/TestWETH9.sol#L27)

	```solidity
	        require(balanceOf[msg.sender] >= wad);
	```

- Found in contracts/test/TestWETH9.sol [Line: 52](contracts/test/TestWETH9.sol#L52)

	```solidity
	        require(balanceOf[src] >= wad);
	```

- Found in contracts/test/TestWETH9.sol [Line: 55](contracts/test/TestWETH9.sol#L55)

	```solidity
	            require(allowance[src][msg.sender] >= wad);
	```

</details>



## L-7: `nonReentrant` is Not the First Modifier

To protect against reentrancy in other modifiers, the `nonReentrant` modifier should be the first modifier in the list of modifiers.

<details><summary>18 Found Instances</summary>


- Found in contracts/ClearingHouse.sol [Line: 162](contracts/ClearingHouse.sol#L162)

	```solidity
	        nonReentrant
	```

- Found in contracts/ClearingHouse.sol [Line: 236](contracts/ClearingHouse.sol#L236)

	```solidity
	        nonReentrant
	```

- Found in contracts/ClearingHouse.sol [Line: 309](contracts/ClearingHouse.sol#L309)

	```solidity
	        nonReentrant
	```

- Found in contracts/ClearingHouse.sol [Line: 323](contracts/ClearingHouse.sol#L323)

	```solidity
	        nonReentrant
	```

- Found in contracts/ClearingHouse.sol [Line: 342](contracts/ClearingHouse.sol#L342)

	```solidity
	        nonReentrant
	```

- Found in contracts/ClearingHouse.sol [Line: 402](contracts/ClearingHouse.sol#L402)

	```solidity
	    ) external override whenNotPaused nonReentrant {
	```

- Found in contracts/ClearingHouse.sol [Line: 407](contracts/ClearingHouse.sol#L407)

	```solidity
	    function liquidate(address trader, address baseToken) external override whenNotPaused nonReentrant {
	```

- Found in contracts/ClearingHouse.sol [Line: 417](contracts/ClearingHouse.sol#L417)

	```solidity
	    ) external override whenNotPaused nonReentrant {
	```

- Found in contracts/ClearingHouse.sol [Line: 427](contracts/ClearingHouse.sol#L427)

	```solidity
	    function cancelAllExcessOrders(address maker, address baseToken) external override whenNotPaused nonReentrant {
	```

- Found in contracts/Vault.sol [Line: 137](contracts/Vault.sol#L137)

	```solidity
	        nonReentrant
	```

- Found in contracts/Vault.sol [Line: 153](contracts/Vault.sol#L153)

	```solidity
	    ) external override whenNotPaused nonReentrant onlySettlementOrCollateralToken(token) {
	```

- Found in contracts/Vault.sol [Line: 166](contracts/Vault.sol#L166)

	```solidity
	    function depositEther() external payable override whenNotPaused nonReentrant {
	```

- Found in contracts/Vault.sol [Line: 172](contracts/Vault.sol#L172)

	```solidity
	    function depositEtherFor(address to) external payable override whenNotPaused nonReentrant {
	```

- Found in contracts/Vault.sol [Line: 192](contracts/Vault.sol#L192)

	```solidity
	        nonReentrant
	```

- Found in contracts/Vault.sol [Line: 204](contracts/Vault.sol#L204)

	```solidity
	    function withdrawEther(uint256 amount) external override whenNotPaused nonReentrant {
	```

- Found in contracts/Vault.sol [Line: 220](contracts/Vault.sol#L220)

	```solidity
	        nonReentrant
	```

- Found in contracts/Vault.sol [Line: 235](contracts/Vault.sol#L235)

	```solidity
	    function withdrawAllEther() external override whenNotPaused nonReentrant returns (uint256 amount) {
	```

- Found in contracts/Vault.sol [Line: 251](contracts/Vault.sol#L251)

	```solidity
	    ) external override whenNotPaused nonReentrant returns (uint256) {
	```

</details>



## L-8: Modifier Invoked Only Once

Consider removing the modifier or inlining the logic into the calling function.

<details><summary>2 Found Instances</summary>


- Found in contracts/ClearingHouseConfig.sol [Line: 14](contracts/ClearingHouseConfig.sol#L14)

	```solidity
	    modifier checkRatio(uint24 ratio) {
	```

- Found in contracts/MarketRegistry.sol [Line: 45](contracts/MarketRegistry.sol#L45)

	```solidity
	    modifier onlyFeeManager() {
	```

</details>



## L-9: Internal Function Used Only Once

Instead of separating the logic into a separate function, consider inlining the logic into the calling function. This can reduce the number of function calls and improve readability.

<details><summary>4 Found Instances</summary>


- Found in contracts/lib/PerpMath.sol [Line: 46](contracts/lib/PerpMath.sol#L46)

	```solidity
	    function neg256(uint256 a) internal pure returns (int256) {
	```

- Found in contracts/lib/PerpMath.sol [Line: 87](contracts/lib/PerpMath.sol#L87)

	```solidity
	    function mulDiv(
	```

- Found in contracts/lib/SwapMath.sol [Line: 79](contracts/lib/SwapMath.sol#L79)

	```solidity
	    function calcAmountWithFeeRatioReplaced(
	```

- Found in contracts/lib/UniswapV3Broker.sol [Line: 234](contracts/lib/UniswapV3Broker.sol#L234)

	```solidity
	    function getSqrtMarketTwapX96From(
	```

</details>



## L-10: Loop Contains `require`/`revert`

Avoid `require` / `revert` statements in a loop because a single bad item can cause the whole transaction to fail. It's better to forgive on fail and return failed elements post processing of the loop

<details><summary>14 Found Instances</summary>


- Found in contracts/AccountBalance.sol [Line: 230](contracts/AccountBalance.sol#L230)

	```solidity
	        for (uint256 i = 0; i < tokenLen; i++) {
	```

- Found in contracts/AccountBalance.sol [Line: 263](contracts/AccountBalance.sol#L263)

	```solidity
	        for (uint256 i = 0; i < tokenLen; i++) {
	```

- Found in contracts/AccountBalance.sol [Line: 392](contracts/AccountBalance.sol#L392)

	```solidity
	        for (uint256 i = 0; i < tokenLen; i++) {
	```

- Found in contracts/AccountBalance.sol [Line: 508](contracts/AccountBalance.sol#L508)

	```solidity
	        for (uint256 i = 0; i < tokenLen; i++) {
	```

- Found in contracts/ClearingHouse.sol [Line: 299](contracts/ClearingHouse.sol#L299)

	```solidity
	        for (uint256 i = 0; i < baseTokenLength; i++) {
	```

- Found in contracts/ClearingHouse.sol [Line: 776](contracts/ClearingHouse.sol#L776)

	```solidity
	        for (uint256 i = 0; i < length; i++) {
	```

- Found in contracts/Exchange.sol [Line: 322](contracts/Exchange.sol#L322)

	```solidity
	        for (uint256 i = 0; i < baseTokenLength; i++) {
	```

- Found in contracts/OrderBook.sol [Line: 212](contracts/OrderBook.sol#L212)

	```solidity
	        for (uint256 i = 0; i < orderIdLength; i++) {
	```

- Found in contracts/OrderBook.sol [Line: 278](contracts/OrderBook.sol#L278)

	```solidity
	        while (swapState.amountSpecifiedRemaining != 0 && swapState.sqrtPriceX96 != params.sqrtPriceLimitX96) {
	```

- Found in contracts/OrderBook.sol [Line: 428](contracts/OrderBook.sol#L428)

	```solidity
	        for (uint256 i = 0; i < baseTokens.length; i++) {
	```

- Found in contracts/OrderBook.sol [Line: 459](contracts/OrderBook.sol#L459)

	```solidity
	        for (uint256 i = 0; i < orderIds.length; i++) {
	```

- Found in contracts/OrderBook.sol [Line: 507](contracts/OrderBook.sol#L507)

	```solidity
	        for (uint256 i = 0; i < orderIdLength; i++) {
	```

- Found in contracts/OrderBook.sol [Line: 713](contracts/OrderBook.sol#L713)

	```solidity
	        for (uint256 i = 0; i < orderIdLength; i++) {
	```

- Found in contracts/Vault.sol [Line: 891](contracts/Vault.sol#L891)

	```solidity
	        for (uint256 i = 0; i < tokenLen; i++) {
	```

</details>



## L-11: Unused State Variable

State variable appears to be unused. No analysis has been performed to see if any inline assembly references it. Consider removing this unused variable.

<details><summary>1 Found Instances</summary>


- Found in contracts/VirtualToken.sol [Line: 12](contracts/VirtualToken.sol#L12)

	```solidity
	    uint256[50] private __gap;
	```

</details>



## L-12: Dead Code

Functions that are not used. Consider removing them.

<details><summary>1 Found Instances</summary>


- Found in contracts/ClearingHouse.sol [Line: 1102](contracts/ClearingHouse.sol#L1102)

	```solidity
	    function _getTotalAbsPositionValue(address trader) internal view returns (uint256) {
	```

</details>



## L-13: Costly operations inside loop

Invoking `SSTORE` operations in loops may waste gas. Use a local variable to hold the loop computation result.

<details><summary>5 Found Instances</summary>


- Found in contracts/AccountBalance.sol [Line: 462](contracts/AccountBalance.sol#L462)

	```solidity
	        for (uint256 i; i < tokenLen; i++) {
	```

- Found in contracts/OrderBook.sol [Line: 212](contracts/OrderBook.sol#L212)

	```solidity
	        for (uint256 i = 0; i < orderIdLength; i++) {
	```

- Found in contracts/OrderBook.sol [Line: 278](contracts/OrderBook.sol#L278)

	```solidity
	        while (swapState.amountSpecifiedRemaining != 0 && swapState.sqrtPriceX96 != params.sqrtPriceLimitX96) {
	```

- Found in contracts/OrderBook.sol [Line: 602](contracts/OrderBook.sol#L602)

	```solidity
	        for (uint256 idx = 0; idx < orderLen; idx++) {
	```

- Found in contracts/Vault.sol [Line: 735](contracts/Vault.sol#L735)

	```solidity
	            for (uint256 i; i < tokenLen; i++) {
	```

</details>



## L-14: Missing Inheritance

There is an interface / abstract contract that is potentially missing (not included in) the inheritance of this contract.

<details><summary>1 Found Instances</summary>


- Found in contracts/test/TestWETH9.sol [Line: 4](contracts/test/TestWETH9.sol#L4)

	Is this contract supposed to implement an interface? Consider extending one of the following: IERC20, IERC20Metadata, IERC20Upgradeable, IWETH9
	```solidity
	contract TestWETH9 {
	```

</details>



## L-15: Unused Import

Redundant import statement. Consider removing it.

<details><summary>6 Found Instances</summary>


- Found in contracts/ClearingHouse.sol [Line: 12](contracts/ClearingHouse.sol#L12)

	```solidity
	import { FullMath } from "@uniswap/v3-core/contracts/libraries/FullMath.sol";
	```

- Found in contracts/ClearingHouse.sol [Line: 17](contracts/ClearingHouse.sol#L17)

	```solidity
	import { AccountMarket } from "./lib/AccountMarket.sol";
	```

- Found in contracts/Exchange.sol [Line: 29](contracts/Exchange.sol#L29)

	```solidity
	import { OpenOrder } from "./lib/OpenOrder.sol";
	```

- Found in contracts/OrderBook.sol [Line: 16](contracts/OrderBook.sol#L16)

	```solidity
	import { PerpFixedPoint96 } from "./lib/PerpFixedPoint96.sol";
	```

- Found in contracts/test/TestUniswapV3Broker.sol [Line: 9](contracts/test/TestUniswapV3Broker.sol#L9)

	```solidity
	import "@uniswap/v3-periphery/contracts/libraries/PoolAddress.sol";
	```

- Found in contracts/test/TestUniswapV3Broker.sol [Line: 11](contracts/test/TestUniswapV3Broker.sol#L11)

	```solidity
	import "@uniswap/v3-periphery/contracts/libraries/Path.sol";
	```

</details>



## L-16: State Variable Could Be Constant

State variables that are not updated following deployment should be declared constant to save gas. Add the `constant` attribute to state variables that never change.

<details><summary>3 Found Instances</summary>


- Found in contracts/test/TestWETH9.sol [Line: 5](contracts/test/TestWETH9.sol#L5)

	```solidity
	    string public name = "Wrapped Ether";
	```

- Found in contracts/test/TestWETH9.sol [Line: 6](contracts/test/TestWETH9.sol#L6)

	```solidity
	    string public symbol = "WETH";
	```

- Found in contracts/test/TestWETH9.sol [Line: 7](contracts/test/TestWETH9.sol#L7)

	```solidity
	    uint8 public decimals = 18;
	```

</details>



## L-17: State Change Without Event

There are state variable changes in this function but no event is emitted. Consider emitting an event to enable offchain indexers to track the changes.

<details><summary>24 Found Instances</summary>


- Found in contracts/AccountBalance.sol [Line: 65](contracts/AccountBalance.sol#L65)

	```solidity
	    function modifyTakerBalance(
	```

- Found in contracts/AccountBalance.sol [Line: 92](contracts/AccountBalance.sol#L92)

	```solidity
	    function settleOwedRealizedPnl(address trader) external override returns (int256) {
	```

- Found in contracts/AccountBalance.sol [Line: 121](contracts/AccountBalance.sol#L121)

	```solidity
	    function registerBaseToken(address trader, address baseToken) external override {
	```

- Found in contracts/AccountBalance.sol [Line: 134](contracts/AccountBalance.sol#L134)

	```solidity
	    function deregisterBaseToken(address trader, address baseToken) external override {
	```

- Found in contracts/AccountBalance.sol [Line: 140](contracts/AccountBalance.sol#L140)

	```solidity
	    function updateTwPremiumGrowthGlobal(
	```

- Found in contracts/Exchange.sol [Line: 144](contracts/Exchange.sol#L144)

	```solidity
	    function swap(SwapParams memory params) external override returns (SwapResponse memory) {
	```

- Found in contracts/OrderBook.sol [Line: 99](contracts/OrderBook.sol#L99)

	```solidity
	    function addLiquidity(AddLiquidityParams calldata params) external override returns (AddLiquidityResponse memory) {
	```

- Found in contracts/OrderBook.sol [Line: 175](contracts/OrderBook.sol#L175)

	```solidity
	    function removeLiquidity(RemoveLiquidityParams calldata params)
	```

- Found in contracts/OrderBook.sol [Line: 198](contracts/OrderBook.sol#L198)

	```solidity
	    function updateFundingGrowthAndLiquidityCoefficientInFundingPayment(
	```

- Found in contracts/OrderBook.sol [Line: 239](contracts/OrderBook.sol#L239)

	```solidity
	    function updateOrderDebt(
	```

- Found in contracts/OrderBook.sol [Line: 260](contracts/OrderBook.sol#L260)

	```solidity
	    function replaySwap(ReplaySwapParams memory params) external override returns (ReplaySwapResponse memory) {
	```

- Found in contracts/base/SafeOwnable.sol [Line: 53](contracts/base/SafeOwnable.sol#L53)

	```solidity
	    function setOwner(address newOwner) external onlyOwner {
	```

- Found in contracts/test/TestAccountBalance.sol [Line: 28](contracts/test/TestAccountBalance.sol#L28)

	```solidity
	    function setBlockTimestamp(uint256 blockTimestamp) external {
	```

- Found in contracts/test/TestAccountBalance.sol [Line: 52](contracts/test/TestAccountBalance.sol#L52)

	```solidity
	    function mockMarkPrice(address baseToken, uint256 price) external {
	```

- Found in contracts/test/TestAccountBalance.sol [Line: 56](contracts/test/TestAccountBalance.sol#L56)

	```solidity
	    function revertMockedMarkPrice(address baseToken) external {
	```

- Found in contracts/test/TestChainlinkPriceFeed.sol [Line: 22](contracts/test/TestChainlinkPriceFeed.sol#L22)

	```solidity
	    function setPrice(uint256 price) external {
	```

- Found in contracts/test/TestChainlinkPriceFeed.sol [Line: 26](contracts/test/TestChainlinkPriceFeed.sol#L26)

	```solidity
	    function setSequencerStatus(bool sequencerIsDown) external {
	```

- Found in contracts/test/TestClearingHouse.sol [Line: 38](contracts/test/TestClearingHouse.sol#L38)

	```solidity
	    function setBlockTimestamp(uint256 blockTimestamp) external {
	```

- Found in contracts/test/TestERC20.sol [Line: 28](contracts/test/TestERC20.sol#L28)

	```solidity
	    function setTransferFeeRatio(uint256 ratio) external {
	```

- Found in contracts/test/TestExchange.sol [Line: 14](contracts/test/TestExchange.sol#L14)

	```solidity
	    function setBlockTimestamp(uint256 blockTimestamp) external {
	```

- Found in contracts/test/TestMetaTxRecipient.sol [Line: 14](contracts/test/TestMetaTxRecipient.sol#L14)

	```solidity
	    function poke() external {
	```

- Found in contracts/test/TestUniswapV3Broker.sol [Line: 21](contracts/test/TestUniswapV3Broker.sol#L21)

	```solidity
	    function initialize(address factory) external initializer {
	```

- Found in contracts/test/TestWhitelistERC20.sol [Line: 26](contracts/test/TestWhitelistERC20.sol#L26)

	```solidity
	    function addWhitelist(address addr) external onlyOwner {
	```

- Found in contracts/test/TestWhitelistERC20.sol [Line: 30](contracts/test/TestWhitelistERC20.sol#L30)

	```solidity
	    function removeWhitelist(address addr) external onlyOwner {
	```

</details>



## L-18: State Variable Could Be Immutable

State variables that are only changed in the constructor should be declared immutable to save gas. Add the `immutable` attribute to state variables that are only changed in the constructor

<details><summary>1 Found Instances</summary>


- Found in contracts/test/TestLimitOrderBook.sol [Line: 8](contracts/test/TestLimitOrderBook.sol#L8)

	```solidity
	    address internal _clearingHouse;
	```

</details>



## L-19: Unchecked Return

Function returns a value but it is ignored. Consider checking the return value.

<details><summary>18 Found Instances</summary>


- Found in contracts/AccountBalance.sol [Line: 111](contracts/AccountBalance.sol#L111)

	```solidity
	        _modifyTakerBalance(trader, baseToken, takerBase, takerQuote);
	```

- Found in contracts/ClearingHouse.sol [Line: 252](contracts/ClearingHouse.sol#L252)

	```solidity
	        _settleFunding(trader, params.baseToken);
	```

- Found in contracts/ClearingHouse.sol [Line: 300](contracts/ClearingHouse.sol#L300)

	```solidity
	            _settleFunding(trader, baseTokens[i]);
	```

- Found in contracts/ClearingHouse.sol [Line: 358](contracts/ClearingHouse.sol#L358)

	```solidity
	        _settleFunding(trader, params.baseToken);
	```

- Found in contracts/ClearingHouse.sol [Line: 446](contracts/ClearingHouse.sol#L446)

	```solidity
	        _settleFunding(trader, baseToken);
	```

- Found in contracts/ClearingHouse.sol [Line: 623](contracts/ClearingHouse.sol#L623)

	```solidity
	        _settleFunding(trader, baseToken);
	```

- Found in contracts/ClearingHouse.sol [Line: 624](contracts/ClearingHouse.sol#L624)

	```solidity
	        _settleFunding(liquidator, baseToken);
	```

- Found in contracts/ClearingHouse.sol [Line: 762](contracts/ClearingHouse.sol#L762)

	```solidity
	        _settleFunding(maker, baseToken);
	```

- Found in contracts/ClearingHouse.sol [Line: 926](contracts/ClearingHouse.sol#L926)

	```solidity
	        _settleFunding(trader, params.baseToken);
	```

- Found in contracts/CollateralManager.sol [Line: 65](contracts/CollateralManager.sol#L65)

	```solidity
	        requireValidCollateralMmRatio(mmRatioBufferArg);
	```

- Found in contracts/CollateralManager.sol [Line: 137](contracts/CollateralManager.sol#L137)

	```solidity
	        requireValidCollateralMmRatio(mmRatioBuffer);
	```

- Found in contracts/InsuranceFund.sol [Line: 83](contracts/InsuranceFund.sol#L83)

	```solidity
	        IERC20Upgradeable(token).approve(vault, repaidAmount);
	```

- Found in contracts/lib/UniswapV3Broker.sol [Line: 124](contracts/lib/UniswapV3Broker.sol#L124)

	```solidity
	        IUniswapV3Pool(params.pool).collect(
	```

- Found in contracts/test/TestClearingHouse.sol [Line: 85](contracts/test/TestClearingHouse.sol#L85)

	```solidity
	        IAccountBalance(_accountBalance).modifyTakerBalance(
	```

- Found in contracts/test/TestLimitOrderBook.sol [Line: 17](contracts/test/TestLimitOrderBook.sol#L17)

	```solidity
	        IClearingHouse(_clearingHouse).openPositionFor(
	```

- Found in contracts/test/TestUniswapV3Broker.sol [Line: 39](contracts/test/TestUniswapV3Broker.sol#L39)

	```solidity
	            IERC20Metadata(IUniswapV3Pool(pool).token0()).transfer(msg.sender, amount0Owed);
	```

- Found in contracts/test/TestUniswapV3Broker.sol [Line: 42](contracts/test/TestUniswapV3Broker.sol#L42)

	```solidity
	            IERC20Metadata(IUniswapV3Pool(pool).token1()).transfer(msg.sender, amount1Owed);
	```

- Found in contracts/test/TestUniswapV3Broker.sol [Line: 70](contracts/test/TestUniswapV3Broker.sol#L70)

	```solidity
	        IERC20Metadata(token).transfer(msg.sender, amountToPay);
	```

</details>



